<?php
/**
 * @file
 * Custom modifications for Dev Portal
 *
 * @author
 * Chris Novak <cnovak@apigee.com>
 *
 * @since 2013-04-Jul
 */

/**
 * Implements hook_menu()
 */
function swisscom_custom_menu() {
  $items = array();
  $items['admin/config/swisscom_custom'] = array(
    'title' => 'Swisscom settings',
    'description' => 'Custom settings for Swisscom.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('swisscom_custom_admin_settings'),
    'access arguments' => array('access administration pages'),
    'file' => 'swisscom_custom.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implementation of hook_perm().
 */
function swisscom_custom_permission() {
  return array(
    'view/edit user admin notes field' => array(
      'title' => t('View/edit user admin notes field')
    ),
  );
}

/**
 * Implements hook_menu_alter().
 */
function swisscom_custom_menu_alter(&$items) {
  // Change callback of logintoboggan_denied so we can change 403 header.
  $items['toboggan/denied']['page callback'] = 'swisscom_custom_denied';
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function swisscom_custom_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  // The http://www22.verizon.com/about/terms/ link needs to be here, because
  // the URL must end in a slash, and URL redirect will remove it.
  $form['field_terms_and_conditions'][LANGUAGE_NONE]['#title'] = t('I agree to the <a href="@url" target="_blank">Terms of Use</a>', array('@url' => url('terms-use')));
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function swisscom_custom_form_user_profile_form_alter(&$form, &$form_state, $form_id) {

  // Remove openid section from user profile, disabling devconnect_sso does not do this.
  unset($form['openid']);

  // Disabled the Terms and Conditions field when displaying on user form.
  $form['field_terms_and_conditions']['#disabled'] = TRUE;

  // Make sure the admin notes field is hidden for people whom do not have permission.
  if (!user_access('view/edit user admin notes field')) {
    unset($form['field_admin_notes']);
  }

  // Check for mass contact module and Override the default Title and Description
  if(module_exists('mass_contact')) {
    $form['mass_contact']['#title'] = NULL;
    $form['mass_contact']['mass_contact_optout']['#title'] = t('Check if you do not want to receive notifications on new Apis and updates.');
    $form['mass_contact']['mass_contact_optout']['#description'] = NULL;
  }
  
}

/**
 * Called from the menu alter, remove the 403 access denied
 * so that the Swisscom firewall on dev does not intercept
 * the 403 response and show it's own page.
 * @return array|string
 */
function swisscom_custom_denied() {
  $page = logintoboggan_denied();
  $swisscom_custom_403_error_is_removed = variable_get('swisscom_custom_403_error_is_removed', FALSE);
  if($swisscom_custom_403_error_is_removed) {
    drupal_add_http_header('HTTP/1.1', '200 OK');
  }
  return $page;
}

/**
 * @file
 * Bulk export of objects generated by Bulk export module.
 */

/**
 * Implements hook_views_api().
 */
function swisscom_custom_views_api($module, $api) {
  if ($module == 'views' && $api == 'views_default') {
    return array('version' => 2);
  }
}

/*
 * Redirect user on logout
 */
function swisscom_custom_user_logout($account) {
  $_GET['destination'] = '<front>';
}

function swisscom_custom_get_api_products() {
  try {
    $options = array();
    $api_product_obj = new Apigee\ManagementAPI\APIProduct($client);
    $api_products = $api_product_obj->listProducts();
    drupal_alter('apiproduct_list', $api_products);
    foreach ($api_products as $api_product) {
      $options['prod-' . $api_product->getName()] = $api_product->getDisplayName();
    }
  } catch (Exception $e) {
    drupal_set_message($e->getMessage(), 'error');
    $options = array(); // TODO: come up with a more elegant way of handling this.
  }
  return $options;
}


/**
 * Implements hook_element_info_alter().
 * Alters phone number to make validation
 * @see hook_element_info_alter()
 * @author
 * Seshi <seshireddy@apigee.com>
 * JIRA -- SWISSCOM-94
 */
function swisscom_custom_element_info_alter(&$type) {
  // Add validation for phone number.
  if (isset($type['phone_number']['#input'])) {
    $type['phone_number']['#element_validate'][] = '_validate_mobile_number';
  }
}

function _validate_mobile_number(&$element, &$form_state) {
  $item = $element['#value'];
  $field = field_widget_field($element, $form_state);
  $instance = field_widget_instance($element, $form_state);
  $settings = $instance['settings'];

  if($element['number']['#required'] == 1 && empty($element['number']['#value']) ) {
	$error = t('@field_name is required.',array('@field_name' => $element['#title']) );
	form_set_error($field['field_name'], $error);
  }
   
}
